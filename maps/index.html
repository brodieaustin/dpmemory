<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Map</title>
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; font-size: 13px; color: #333; overflow: hidden;}
      .header{height: 32px; padding: 0 6px; background-color: #333;}
      .branding{display: block; height: 100%; line-height: 32px; font-weight: bold; color: #63af00; text-decoration: none; text-transform: uppercase;}
      .white{font-weight: normal; color: #fff;}
      #map-canvas { width: 80%; height: 100%; float: left; background-color: #eee;}
      #results {position: relative; width: 18.9%; height: 100%; float: right; padding: 0 0.46875%; background-color: #fff; overflow-y: scroll; overflow-x: hidden;}
      #results h2{margin-bottom: 0;}
      #results ul{list-style: none; margin: 0; padding: 0; text-align: center;}
      #results ul li{padding: 6px 0; line-height: 1.5; border-top: 1px solid #eee;}
      #results ul li:last-child{border-bottom: 1px solid #eee;}
      #results ul li a{text-decoration: none;}
      #results-count p{margin-top: 6px;}
      .item-title{display: block; font-size: 11px; color: #333;}
      .count{color: #888;}
      .label{background-color: red; color: #fff; width: 14px; height: 14px; line-height: 12px; border-radius: 9px; border: 1px solid #111; font-size: 10px; font-weight: bold; text-align: center;}
      .load{display: none; position: absolute; top: 32px; left: 0; width: 100px; height: 40px; line-height: 40px; padding-left: 46px; background: #fff url('ajax-loader.gif') no-repeat 4px center; z-index: 1000;}
    </style>
</head>
<body>
    <div class="header">
        <a href="#" class="branding"><span class="white">Des Plaines</span> Memory</a>
    </div>
    <div id="results">
        <p>Click on map marker to see items related to that location. Results will appear here.</p>
        <h2>Results</h2>
        <div id="results-count"></div>
        <div id="results-list"></div>
    </div>
    <div id="map-canvas"></div>
    <div class="load">Loading map...</div>
    <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>-->
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCimpd2qM4HIR8kVRK8yjA-sQ6TpA_Zf_M&sensor=false"></script>
    <script src="markerwithlabel_packed.js"></script>
    <script>
        $(document).ready(function(){
            $('.load').show();
            
            var mapOptions = {
              center: new google.maps.LatLng(42.037995,-87.874149),
              zoom: 14,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            
            var map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);
                
            var locations = new Array();
            var records;
            
            //patterns for detetcting lat lng
            var p = /-*[0-9]{2}\.[0-9]+,/;
            var lat, lng;
                
                
            $.getJSON('data.php', {p : 'p15770coll2!p15770coll2'}, function(data){
                records = data.records;
                $.each(records, function(i, record){
                    if (record.locati.length > 0){
                        var loc = record.locati;
                                                             
                        if (locations[loc]){
                            locations[loc].push({"id" : record.pointer, "title" : record.title, "collection" : record.collection});
                        }
                        else{
                            locations[loc] = [{"id" : record.pointer, "title" : record.title, "collection" : record.collection}];
                        }
                    }
                    
                });
                
                
                for (var key in locations){
                    if (p.test(key) == false){
                            /*geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ 'address': loc}, function(results, status) {
                                console.log(status);
                                if (status == google.maps.GeocoderStatus.OK) {
                                    var marker = new google.maps.Marker({
                                        map: map,
                                        position: results[0].geometry.location,
                                        title : record.title
                                    });
	                           }
	                       });*/
	                   }
	                   else{
	                        lat = parseFloat(key.split(',')[0].trim());
	                        lng = parseFloat(key.split(',')[1].trim());
	                        var marker = new MarkerWithLabel({
                               position: new google.maps.LatLng(lat, lng),
                               map: map,
                               flat: true,
                               title : key,
                               labelContent: locations[key].length,
                               labelAnchor: new google.maps.Point(0, 40),
                               labelClass: "label", // the CSS class for the label
                               labelStyle: {opacity: 0.90},
                               labelInBackground: false
                             });
                             
                             showItems(marker, records);
	                   } 
                }
                
                $('.load').hide();
                
            });
            
            function showItems(marker){
                google.maps.event.addListener(marker, 'click', function() {
                    var list, img, key;
                    
                    key = marker.getTitle();
                    
                    $('#results-list ul').hide();
                    
                    //console.log($('#' + key).length);
                    
                    if ($('#' + key).length != 0){
                        $('#' + key).show();
                    }
                    else{
                        list = '<ul id="' + key + '">';
                        
                        $.each(locations[key], function(i){
                            console.log(locations[key][i]);  
                            img = '<li><a href="http://www.desplainesmemory.org/cdm/ref/collection' + locations[key][i]['collection'] + '/id/' + locations[key][i]['id'] + '" class="item-image" target="_blank"><img src="http://www.desplainesmemory.org/utils/getthumbnail/collection' + locations[key][i]['collection'] + '/id/' + locations[key][i]['id'] + '"><span class="item-title">' + locations[key][i]['title'] + '</span></a></li>';
                            list+= img;
                        });
                        
                        $('#results-list').append(list).show();
                    }
                    $('#results-count').html('').append('<p>' + key + ' (' + locations[key].length + (locations[key].length == 1?' item':' items') + ')</p>');
                });
                
            }
            
        });
    </script>
</body>
</html>
